æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã§ã€€ã€€ã€€ã€€ã€€ã€€å¤§é‡ã®PNGç”»åƒã‚’ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã„ã‹ã«é«˜é€Ÿã«å‡¦ç†ã™ã‚‹ã‹
Go Conference 2019 Spring
18 May 2019

[[https://twitter.com/cia_rana][CIARANA]]

* è‡ªå·±ç´¹ä»‹

.image face.jpg

*CIARANA*/*Twitter:* *cia_rana*/*GitHub:* *cia-rana*
2019å¹´4æœˆ æ ªå¼ä¼šç¤¾ã‚µã‚¤ãƒãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ æ–°å’å…¥ç¤¾
[[https://adtech.cyberagent.io/][ã‚¢ãƒ‰ãƒ†ã‚¯ã‚¹ã‚¿ã‚¸ã‚ª]]ã§ã‚¯ãƒªã‚¨ã‚¤ã‚¿æ”¯æ´ãƒ„ãƒ¼ãƒ«ä½œã£ã¦ã¾ã™

* èƒŒæ™¯

* èƒŒæ™¯
- å‹•ç”»ã‚’ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ
- å‹•ç”»â†’é€£ç•ªPNGã«å¤‰æ›ã—ã¦Goã§å‡¦ç†ã—ãŸ
- ã‚ã¡ã‚ƒãã¡ã‚ƒå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ãŸ

* ã©ã†ã‚„ã£ã¦å‡¦ç†ã‚’æ—©ãã™ã‚‹ã‹ï¼Ÿ
- ãƒã‚·ãƒ³ã‚¹ãƒšãƒƒã‚¯ã‚’ä¸Šã’ã‚‹
- cgo çµŒç”±ã§Cã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‘¼ã¶
- Goã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã™

* ã©ã†ã‚„ã£ã¦å‡¦ç†ã‚’æ—©ãã™ã‚‹ã‹ï¼Ÿ
- ãƒã‚·ãƒ³ã‚¹ãƒšãƒƒã‚¯ã‚’ä¸Šã’ã‚‹
- cgo çµŒç”±ã§Cã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‘¼ã¶
- Goã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã™ ğŸ‘ˆ ã“ã®ãƒ—ãƒ©ãƒ³ã‚’æ¡ç”¨

* æ‰‹ã‚ãŸã‚Šæ¬¡ç¬¬ã‚³ãƒ¼ãƒ‰ã«æ‰‹ã‚’åŠ ãˆã¦ã‚‚æ™‚é–“ã®ãƒ ãƒ€ğŸ˜©

* æ¨æ¸¬ã™ã‚‹ãªã€è¨ˆæ¸¬ã›ã‚ˆ

* Rob Pike, "Notes on Programming in C", 1989
> Rule 1. You can't tell where a program is going to spend its time. Bottlenecks occur in surprising places, so *don't*try*to*second*guess*and*put*in*a*speed*hack*until*you've*proven*that's*where*the*bottleneck*is*.

> Rule 2. *Measure*. Don't tune for speed until you've measured, and even then don't unless one part of the code _overwhelms_ the rest.

* ã©ã†ã‚„ã£ã¦ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’è¦‹ã¤ã‘ã‚‹ã‹ï¼Ÿ

* pprof ãŒã‚ã‚‹ã˜ã‚ƒãªã„ï¼

* pprof
â— Go å…¬å¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©
â— runtime/pprof

- é–¢æ•°ã”ã¨ã®å®Ÿè¡Œæ™‚é–“ã€ãƒ¡ãƒ¢ãƒªæƒ…å ±ã€goroutineã®æƒ…å ±ã‚’å–å¾—ã§ãã‚‹

â— net/http/pprof

- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚ºã—ã¦è¦‹ãŸã„å ´åˆã¯ã“ã£ã¡ã‚’ä½¿ã†

â— github.com/pkg/profile

- pprof ã®ç°¡æ˜“ç‰ˆ

* ä½¿ç”¨ç”»åƒ
â— ã“ã“ã®ç”»åƒã‚’ä½¿ã‚ã›ã¦ã„ãŸã ãã¾ã—ãŸ
ğŸ‘‰ https://github.com/ashleymcnamara/gophers 
â— 96æšã®PNGç”»åƒã§å…¨ä½“ã®ã‚µã‚¤ã‚ºã¯ç´„68MB
.image gophers.png 294 400
â€œGopher Artworkâ€ by Ashley McNamara is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.

* å®Ÿè¡Œç’°å¢ƒ
â— OS: Ubuntu 16.04 LTS
â— Go: go1.11.2 linux/amd64
â— Memory: 2GB
â— CPU: Intel Core i5-3340M CPU @ 2.70GHzï¼ˆä½¿ç”¨å¯èƒ½ãªã‚³ã‚¢æ•°ã‚’1ã«åˆ¶é™ï¼‰

* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰1: ãŸãŸãå°

ãƒã‚¬ãƒã‚¸åè»¢ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªã‚³ãƒ¼ãƒ‰

.code first.go

* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰1ã®å®Ÿè¡Œæ™‚é–“

 Duration: 2.85mins, Total samples = 157.11s (91.76%)
 Showing nodes accounting for 152.17s, 96.86% of 157.11s total
 Dropped 191 nodes (cum <= 0.79s)
      flat  flat%   sum%        cum   cum%
    23.09s 14.70% 14.70%     35.19s 22.40%  image/png.filter
       16s 10.18% 24.88%        28s 17.82%  runtime.mallocgc
    12.89s  8.20% 33.09%     31.27s 19.90%  compress/flate.(*compressor).deflate
     9.85s  6.27% 39.35%      9.85s  6.27%  compress/flate.matchLen
     9.33s  5.94% 45.29%      9.33s  5.94%  runtime.memmove
     8.29s  5.28% 50.57%     43.39s 27.62%  runtime.convT2Inoptr
     5.59s  3.56% 54.13%      5.59s  3.56%  image/png.abs (inline)
     5.23s  3.33% 57.46%     34.02s 21.65%  image.(*NRGBA).Set
     5.04s  3.21% 60.66%     14.89s  9.48%  compress/flate.(*compressor).findMatch
     4.99s  3.18% 63.84%     76.50s 48.69%  main.ProcessImage
     4.53s  2.88% 66.72%      8.50s  5.41%  image/png.paeth
     4.38s  2.79% 69.51%      5.71s  3.63%  image.(*NRGBA).NRGBAAt
     3.85s  2.45% 71.96%     24.39s 15.52%  image/color.nrgbaModel
     3.60s  2.29% 74.25%      3.60s  2.29%  image/png.abs8 (inline)
     3.10s  1.97% 76.23%      3.10s  1.97%  hash/adler32.update
     3.07s  1.95% 78.18%     23.67s 15.07%  image.(*NRGBA).At
     2.97s  1.89% 80.07%      2.97s  1.89%  image/color.RGBA.RGBA
     2.89s  1.84% 81.91%      5.86s  3.73%  image/color.(*RGBA).RGBA
     2.77s  1.76% 83.67%      4.39s  2.79%  image/png.filterPaeth
     2.76s  1.76% 85.43%     27.15s 17.28%  image/color.(*modelFunc).Convert

* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰1ã®å®Ÿè¡Œæ™‚é–“

 Duration: 2.85mins, Total samples = 157.11s (91.76%)
 Showing nodes accounting for 152.17s, 96.86% of 157.11s total
 Dropped 191 nodes (cum <= 0.79s)
      flat  flat%   sum%        cum   cum%
    23.09s 14.70% 14.70%     35.19s 22.40%  image/png.filter ğŸ‘ˆ
       16s 10.18% 24.88%        28s 17.82%  runtime.mallocgc
    12.89s  8.20% 33.09%     31.27s 19.90%  compress/flate.(*compressor).deflate
     9.85s  6.27% 39.35%      9.85s  6.27%  compress/flate.matchLen
     9.33s  5.94% 45.29%      9.33s  5.94%  runtime.memmove
     8.29s  5.28% 50.57%     43.39s 27.62%  runtime.convT2Inoptr
     5.59s  3.56% 54.13%      5.59s  3.56%  image/png.abs (inline)
     5.23s  3.33% 57.46%     34.02s 21.65%  image.(*NRGBA).Set
     5.04s  3.21% 60.66%     14.89s  9.48%  compress/flate.(*compressor).findMatch
     4.99s  3.18% 63.84%     76.50s 48.69%  main.ProcessImage
     4.53s  2.88% 66.72%      8.50s  5.41%  image/png.paeth
     4.38s  2.79% 69.51%      5.71s  3.63%  image.(*NRGBA).NRGBAAt
     3.85s  2.45% 71.96%     24.39s 15.52%  image/color.nrgbaModel
     3.60s  2.29% 74.25%      3.60s  2.29%  image/png.abs8 (inline)
     3.10s  1.97% 76.23%      3.10s  1.97%  hash/adler32.update
     3.07s  1.95% 78.18%     23.67s 15.07%  image.(*NRGBA).At
     2.97s  1.89% 80.07%      2.97s  1.89%  image/color.RGBA.RGBA
     2.89s  1.84% 81.91%      5.86s  3.73%  image/color.(*RGBA).RGBA
     2.77s  1.76% 83.67%      4.39s  2.79%  image/png.filterPaeth
     2.76s  1.76% 85.43%     27.15s 17.28%  image/color.(*modelFunc).Convert

* image/png.filter

ç”»åƒã®å„è¡Œã§ä»¥ä¸‹ã®5ç¨®é¡ã®å†…ã©ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã†ã¹ãã‹é¸æŠã™ã‚‹

.image gocon2019_func_filter.png

- None
- Sub
- Up
- Average
- Paeth

* æ³¨ç›®ã—ã¦ã„ã‚‹ãƒ”ã‚¯ã‚»ãƒ«ã®ä½ç½®ã®å€¤ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã‚’ç”¨ã„ã¦è¨ˆç®—ã™ã‚‹

.image gocon2019_filter_attention.png 402 600

* filter type: None

.image gocon2019_filter_none.png 402 600

* filter type: Sub

.image gocon2019_filter_sub1.png 402 600

* filter type: Sub

.image gocon2019_filter_sub2.png

* filter type: Up

.image gocon2019_filter_up1.png 402 600

* filter type: Up

.image gocon2019_filter_up2.png

* filter type: Average

.image gocon2019_filter_ave1.png 402 600

* filter type: Average

.image gocon2019_filter_ave2.png

* filter type: Paeth

.image gocon2019_filter_paeth1.png 402 600

* filter type: Paeth

.image gocon2019_filter_paeth2.png

* è¡Œæ¯ã«æœ€é©ãªãƒ•ã‚£ãƒ«ã‚¿ã‚’é¸æŠã™ã‚‹
- è¡Œæ¯ã«ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œã®å€¤ã®å’Œã‚’ã¨ã‚‹
- å€¤ãŒæœ€ã‚‚å°ã•ããªã‚‹ãƒ•ã‚£ãƒ«ã‚¿ã‚’ãã®è¡Œã®ä»£è¡¨ãƒ•ã‚£ãƒ«ã‚¿ã¨ã™ã‚‹

.image gocon2019_select_filter.png

* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰2: 

.code second.go

* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰3: 

.code third.go

* ã¾ã¨ã‚
â— image/png ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯é©åˆ‡ã«ä½¿ãŠã†
â— æ¨æ¸¬ã™ã‚‹ãªã€è¨ˆæ¸¬ã›ã‚ˆ

- æ—©ã™ãã‚‹æœ€é©åŒ–ã¯è«¸æ‚ªã®æ ¹æºã§ã‚ã‚‹, Donald E. Knuth, 1974
â— Goã¸ã®ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã¯æ„å¤–ã¨ç°¡å˜ã«ã§ãã‚‹
